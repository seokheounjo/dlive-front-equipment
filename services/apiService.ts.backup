import { WorkOrder, WorkOrderStatus, WorkOrderType, WorkCompleteData } from '../types';
import { getMockWorkItems } from '../utils/mockData';

// ============ ì—ëŸ¬ íƒ€ì… ì •ì˜ ============

export interface ApiError {
  code: string;
  message: string;
  statusCode?: number;
  details?: any;
}

export class NetworkError extends Error {
  statusCode?: number;
  details?: any;

  constructor(message: string, statusCode?: number, details?: any) {
    super(message);
    this.name = 'NetworkError';
    this.statusCode = statusCode;
    this.details = details;
  }
}

// ============ Circuit Breaker íŒ¨í„´ (ë¬´í•œë£¨í”„ ë°©ì§€) ============

interface CircuitBreakerState {
  failureCount: number;
  lastFailureTime: number;
  state: 'CLOSED' | 'OPEN' | 'HALF_OPEN';
}

class CircuitBreaker {
  private states: Map<string, CircuitBreakerState> = new Map();
  private readonly failureThreshold = 5; // 5ë²ˆ ì—°ì† ì‹¤íŒ¨ ì‹œ ì°¨ë‹¨
  private readonly openDuration = 30000; // 30ì´ˆ ë™ì•ˆ ì°¨ë‹¨
  private readonly halfOpenDuration = 10000; // 10ì´ˆ í›„ ì¬ì‹œë„ í—ˆìš©

  private getState(key: string): CircuitBreakerState {
    if (!this.states.has(key)) {
      this.states.set(key, {
        failureCount: 0,
        lastFailureTime: 0,
        state: 'CLOSED'
      });
    }
    return this.states.get(key)!;
  }

  canRequest(url: string): boolean {
    const state = this.getState(url);
    const now = Date.now();

    if (state.state === 'CLOSED') {
      return true;
    }

    if (state.state === 'OPEN') {
      // OPEN ìƒíƒœ: ì¼ì • ì‹œê°„ í›„ HALF_OPENìœ¼ë¡œ ì „í™˜
      if (now - state.lastFailureTime >= this.openDuration) {
        console.log(`ğŸ”„ Circuit Breaker: ${url} - OPEN â†’ HALF_OPEN (ì¬ì‹œë„ í—ˆìš©)`);
        state.state = 'HALF_OPEN';
        return true;
      }
      console.warn(`â›” Circuit Breaker: ${url} - ìš”ì²­ ì°¨ë‹¨ë¨ (${Math.round((this.openDuration - (now - state.lastFailureTime)) / 1000)}ì´ˆ í›„ ì¬ì‹œë„ ê°€ëŠ¥)`);
      return false;
    }

    if (state.state === 'HALF_OPEN') {
      // HALF_OPEN ìƒíƒœ: í•œ ë²ˆë§Œ ì¬ì‹œë„ í—ˆìš©
      return true;
    }

    return false;
  }

  recordSuccess(url: string): void {
    const state = this.getState(url);
    if (state.state === 'HALF_OPEN') {
      console.log(`âœ… Circuit Breaker: ${url} - HALF_OPEN â†’ CLOSED (ë³µêµ¬ë¨)`);
    }
    state.failureCount = 0;
    state.state = 'CLOSED';
  }

  recordFailure(url: string): void {
    const state = this.getState(url);
    state.failureCount++;
    state.lastFailureTime = Date.now();

    if (state.failureCount >= this.failureThreshold) {
      if (state.state !== 'OPEN') {
        console.error(`ğŸ”´ Circuit Breaker: ${url} - CLOSED â†’ OPEN (${this.failureThreshold}ë²ˆ ì—°ì† ì‹¤íŒ¨, ${this.openDuration / 1000}ì´ˆ ë™ì•ˆ ì°¨ë‹¨)`);
      }
      state.state = 'OPEN';
    } else if (state.state === 'HALF_OPEN') {
      console.warn(`âš ï¸ Circuit Breaker: ${url} - HALF_OPEN â†’ OPEN (ì¬ì‹œë„ ì‹¤íŒ¨)`);
      state.state = 'OPEN';
    }
  }

  reset(): void {
    this.states.clear();
  }
}

// ============ ìš”ì²­ ì¤‘ë³µ ë°©ì§€ (Request Deduplication) ============

interface PendingRequest {
  promise: Promise<Response>;
  timestamp: number;
}

class RequestDeduplicator {
  private pendingRequests: Map<string, PendingRequest> = new Map();
  private readonly maxAge = 5000; // 5ì´ˆ í›„ ë§Œë£Œ

  getOrCreate(key: string, factory: () => Promise<Response>): Promise<Response> {
    // ë§Œë£Œëœ ìš”ì²­ ì •ë¦¬
    this.cleanup();

    const existing = this.pendingRequests.get(key);
    if (existing) {
      console.log(`ğŸ”„ ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨: ${key} (ì´ì „ ìš”ì²­ ì¬ì‚¬ìš©)`);
      return existing.promise;
    }

    const promise = factory();
    this.pendingRequests.set(key, {
      promise,
      timestamp: Date.now()
    });

    // ì™„ë£Œ í›„ ì œê±°
    promise.finally(() => {
      this.pendingRequests.delete(key);
    });

    return promise;
  }

  private cleanup(): void {
    const now = Date.now();
    for (const [key, request] of this.pendingRequests.entries()) {
      if (now - request.timestamp > this.maxAge) {
        this.pendingRequests.delete(key);
      }
    }
  }

  reset(): void {
    this.pendingRequests.clear();
  }
}

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
const circuitBreaker = new CircuitBreaker();
const requestDeduplicator = new RequestDeduplicator();

// ë””ë²„ê¹…ìš©: Circuit Breaker ë¦¬ì…‹ í•¨ìˆ˜ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
if (typeof window !== 'undefined') {
  (window as any).resetCircuitBreaker = () => {
    circuitBreaker.reset();
    requestDeduplicator.reset();
    console.log('âœ… Circuit Breaker ë° Request Deduplicator ì´ˆê¸°í™”ë¨');
  };
}

// ============ ì—ëŸ¬ ë©”ì‹œì§€ í—¬í¼ ============

const getErrorMessage = (statusCode: number, defaultMessage: string = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'): string => {
  switch (statusCode) {
    case 400:
      return 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
    case 401:
      return 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
    case 403:
      return 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    case 404:
      return 'ìš”ì²­í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    case 408:
      return 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    case 429:
      return 'ë„ˆë¬´ ë§ì€ ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    case 500:
      return 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    case 502:
    case 503:
      return 'ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    case 504:
      return 'ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    default:
      return defaultMessage;
  }
};

// ============ API í˜¸ì¶œ í—¬í¼ (ì¬ì‹œë„ ë¡œì§ í¬í•¨) ============

const fetchWithRetry = async (
  url: string,
  options: RequestInit,
  maxRetries: number = 3,
  timeout: number = 30000
): Promise<Response> => {
  // Circuit Breaker ì²´í¬
  if (!circuitBreaker.canRequest(url)) {
    throw new NetworkError(
      'ì¼ì‹œì ìœ¼ë¡œ ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
      503
    );
  }

  // ìš”ì²­ ì¤‘ë³µ ë°©ì§€ (GET ìš”ì²­ë§Œ)
  const requestKey = options.method === 'GET' ? `${url}` : `${url}-${Date.now()}`;

  return requestDeduplicator.getOrCreate(requestKey, async () => {
    let lastError: Error | null = null;

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        // ì„±ê³µí•˜ë©´ Circuit Breaker ì„±ê³µ ê¸°ë¡
        if (response.ok) {
          circuitBreaker.recordSuccess(url);
          return response;
        }

        // 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
        if (response.status >= 400 && response.status < 500) {
          // 404, 401 ë“± í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ëŠ” Circuit Breakerì— ì‹¤íŒ¨ ê¸°ë¡
          circuitBreaker.recordFailure(url);
          throw new NetworkError(
            getErrorMessage(response.status),
            response.status
          );
        }

        // 5xx ì—ëŸ¬ëŠ” ì¬ì‹œë„
        if (response.status >= 500) {
          circuitBreaker.recordFailure(url);
          throw new NetworkError(
            getErrorMessage(response.status),
            response.status
          );
        }

        return response;

      } catch (error: any) {
        lastError = error;

        // AbortError (íƒ€ì„ì•„ì›ƒ)
        if (error.name === 'AbortError') {
          console.error(`API íƒ€ì„ì•„ì›ƒ (ì‹œë„ ${attempt + 1}/${maxRetries}):`, url);
          circuitBreaker.recordFailure(url);

          if (attempt === maxRetries - 1) {
            throw new NetworkError('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 408);
          }
        }
        // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
        else if (error instanceof TypeError && error.message.includes('fetch')) {
          console.error(`ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ (ì‹œë„ ${attempt + 1}/${maxRetries}):`, error);
          circuitBreaker.recordFailure(url);

          if (attempt === maxRetries - 1) {
            throw new NetworkError('ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', undefined, error);
          }
        }
        // NetworkErrorëŠ” ê·¸ëŒ€ë¡œ ì „íŒŒ
        else if (error instanceof NetworkError) {
          // 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
          if (error.statusCode && error.statusCode >= 400 && error.statusCode < 500) {
            throw error;
          }

          if (attempt === maxRetries - 1) {
            throw error;
          }
        }
        // ê¸°íƒ€ ì—ëŸ¬
        else {
          console.error(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt + 1}/${maxRetries}):`, error);
          circuitBreaker.recordFailure(url);

          if (attempt === maxRetries - 1) {
            throw new NetworkError(error.message || 'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ì¬ì‹œë„ ì „ ëŒ€ê¸° (exponential backoff)
        if (attempt < maxRetries - 1) {
          const delay = Math.min(1000 * Math.pow(2, attempt), 5000);
          console.log(`${delay}ms í›„ ì¬ì‹œë„...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨
    throw lastError || new NetworkError('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
};

// ë”ë¯¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜ (ì‹¤ì œ ë”œë¼ì´ë¸Œ ë°ì´í„° ê¸°ë°˜)
const getDummyWorkOrders = (startDate: string, endDate: string): WorkOrder[] => {
  const customers = [
    "ê¹€ì² ìˆ˜", "ë°•ì˜í¬", "ì´ë¯¼ìˆ˜", "ìµœì§€ì€", "ì •ìš°ì§„", "í•œì†Œì˜", "ì˜¤ì¤€í˜¸", "ì‹ ë¯¸ë˜"
  ];

  const workTypes = [
    { type: WorkOrderType.AS, display: "A/S" },
    { type: WorkOrderType.Installation, display: "ì‹ ê·œì„¤ì¹˜" },
    { type: WorkOrderType.Move, display: "ì´ì „ì„¤ì¹˜" },
    { type: WorkOrderType.Change, display: "ìƒí’ˆë³€ê²½" },
    { type: WorkOrderType.Etc, display: "ê¸°íƒ€" }
  ];

  const statuses = [WorkOrderStatus.Pending, WorkOrderStatus.Completed, WorkOrderStatus.Cancelled];
  const addresses = [
    "ì„œìš¸ì‹œ ì†¡íŒŒêµ¬ ì„ì´Œë™ 15ë²ˆì§€ 1í˜¸",
    "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123ë²ˆì§€ 5í˜¸", 
    "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ í•©ì •ë™ 456ë²ˆì§€ 12í˜¸",
    "ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ë°©ë°°ë™ 789ë²ˆì§€ 3í˜¸",
    "ì„œìš¸ì‹œ ìš©ì‚°êµ¬ ì´ì´Œë™ 321ë²ˆì§€ 8í˜¸",
    "ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ ì¸ì‚¬ë™ 654ë²ˆì§€ 2í˜¸",
    "ì„œìš¸ì‹œ ì¤‘êµ¬ ëª…ë™ 987ë²ˆì§€ 15í˜¸",
    "ì„œìš¸ì‹œ ì„±ë™êµ¬ ì„±ìˆ˜ë™ 147ë²ˆì§€ 7í˜¸"
  ];

  const dummyOrders: WorkOrder[] = customers.map((name, index) => {
    const workType = workTypes[index % workTypes.length];
    const status = statuses[index % statuses.length];
    const hour = 9 + (index % 8);
    const minute = (index % 4) * 15;

    return {
      id: `WRK${String(index + 1).padStart(3, '0')}`,
      type: workType.type,
      typeDisplay: workType.display,
      status: status,
      scheduledAt: `2025-09-30T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:00`,
      customer: {
        id: `CUST${String(index + 1).padStart(3, '0')}`,
        name: name,
        phone: `010-${String(Math.floor(Math.random() * 9000) + 1000)}-${String(Math.floor(Math.random() * 9000) + 1000)}`,
        address: addresses[index % addresses.length]
      },
      details: `${workType.display} ì‘ì—… ìš”ì²­`,
      assignedEquipment: [],
      directionId: `WRK${String(index + 1).padStart(3, '0')}`
    };
  });

  return dummyOrders;
};

// ë¡œê·¸ì¸ API
export const login = async (userId: string, password: string): Promise<{
  ok: boolean;
  userId?: string;
  userName?: string;
  userRole?: string;
  crrId?: string;
  soId?: string;
  mstSoId?: string;
}> => {
  const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
  console.log('ğŸ” ë¡œê·¸ì¸ API í˜¸ì¶œ - Origin:', origin, 'API_BASE:', API_BASE);

  try {
    const response = await fetchWithRetry(`${API_BASE}/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify({
        USR_ID: userId,
        USR_PWD: password
      }),
    }, 1); // ë¡œê·¸ì¸ì€ ì¬ì‹œë„ 1íšŒë§Œ

    const result = await response.json();
    return result;
  } catch (error) {
    console.error('ë¡œê·¸ì¸ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
};


// ë”ë¯¸ ëª¨ë“œ í™•ì¸ í•¨ìˆ˜
export const checkDemoMode = (): boolean => {
  return typeof window !== 'undefined' && localStorage.getItem('demoMode') === 'true';
};

// ============ ë”ë¯¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜ë“¤ ============

const getDummySafetyChecks = (): SafetyCheck[] => {
  return [
    {
      INSP_ID: 'INSP001',
      SO_ID: '209',
      CRR_ID: '01',
      INSP_END_DT: '20251015',
      STTL_YN: 'Y',
      CUST_ID: 'CUST001',
      CUST_NM: 'ê¹€ì² ìˆ˜',
      TEL_NO: '010-1234-5678',
      PASS_YN: 'Y',
      PROD_GRP_NM: 'ì¸í„°ë„·+TV'
    },
    {
      INSP_ID: 'INSP002',
      SO_ID: '209',
      CRR_ID: '01',
      INSP_END_DT: '20251014',
      STTL_YN: 'N',
      CUST_ID: 'CUST002',
      CUST_NM: 'ë°•ì˜í¬',
      TEL_NO: '010-2345-6789',
      PASS_YN: 'N',
      FAIL_GRADE: 'B',
      DAPPR_RESN: 'ì¥ë¹„ ë¶ˆëŸ‰',
      PROD_GRP_NM: 'ì¸í„°ë„·'
    },
    {
      INSP_ID: 'INSP003',
      SO_ID: '209',
      CRR_ID: '01',
      INSP_END_DT: '20251013',
      STTL_YN: 'Y',
      CUST_ID: 'CUST003',
      CUST_NM: 'ì´ë¯¼ìˆ˜',
      TEL_NO: '010-3456-7890',
      PASS_YN: 'Y',
      PROD_GRP_NM: 'ì¸í„°ë„·+TV+ì „í™”'
    }
  ];
};

const getDummyENSHistory = (): ENSHistory[] => {
  return [
    {
      MSG_TYP: 'KKO',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      EML_SMS_SND_ID: 'MSG001',
      EML_SMS_SND_TP: '01',
      EML_SMS_SND_TP_NM: 'ì‘ì—…ì™„ë£Œ',
      CUST_ID: 'CUST001',
      CUST_NM: 'ê¹€ì² ìˆ˜',
      SEND_TYPE: 'ì¦‰ì‹œ',
      CELL_PHN: '010-1234-5678',
      SMS_RCV_NO: '1588-1234',
      MESSAGE: 'ì•ˆë…•í•˜ì„¸ìš”. D\'LIVEì…ë‹ˆë‹¤.\nì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      RESULT: 'ì„±ê³µ',
      RSLT_NM: 'ì „ì†¡ì„±ê³µ',
      REG_UID: 'A20230019',
      REG_NM: 'ê¹€ìƒì£¼',
      SOSOK: 'ì†¡íŒŒì§€ì ',
      REG_DATE: '2025-10-16 14:30',
      CREATE_TIME: '2025-10-16 14:30',
      SEND_TIME: '2025-10-16 14:30',
      RSLT_TIME: '2025-10-16 14:31',
      TM_RSLT: 'ì •ìƒ'
    },
    {
      MSG_TYP: 'SMS',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      EML_SMS_SND_ID: 'MSG002',
      EML_SMS_SND_TP: '02',
      EML_SMS_SND_TP_NM: 'ì‘ì—…ì˜ˆì •',
      CUST_ID: 'CUST002',
      CUST_NM: 'ë°•ì˜í¬',
      SEND_TYPE: 'ì˜ˆì•½',
      CELL_PHN: '010-2345-6789',
      SMS_RCV_NO: '1588-1234',
      MESSAGE: 'ë‚´ì¼ ì˜¤ì „ 10ì‹œ ë°©ë¬¸ ì˜ˆì •ì…ë‹ˆë‹¤.',
      RESULT: 'ì„±ê³µ',
      RSLT_NM: 'ì „ì†¡ì„±ê³µ',
      REG_UID: 'A20230019',
      REG_NM: 'ê¹€ìƒì£¼',
      SOSOK: 'ì†¡íŒŒì§€ì ',
      REG_DATE: '2025-10-16 09:00',
      CREATE_TIME: '2025-10-16 09:00',
      SEND_TIME: '2025-10-16 09:01',
      RSLT_TIME: '2025-10-16 09:02',
      TM_RSLT: 'ì •ìƒ'
    },
    {
      MSG_TYP: 'LMS',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      EML_SMS_SND_ID: 'MSG003',
      EML_SMS_SND_TP: '03',
      EML_SMS_SND_TP_NM: 'ì‘ì—…ì·¨ì†Œ',
      CUST_ID: 'CUST003',
      CUST_NM: 'ì´ë¯¼ìˆ˜',
      SEND_TYPE: 'ì¦‰ì‹œ',
      CELL_PHN: '010-3456-7890',
      SMS_RCV_NO: '1588-1234',
      MESSAGE: 'ê³ ê° ìš”ì²­ìœ¼ë¡œ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      RESULT: 'ì‹¤íŒ¨',
      RSLT_NM: 'ì „ì†¡ì‹¤íŒ¨',
      REG_UID: 'A20230019',
      REG_NM: 'ê¹€ìƒì£¼',
      SOSOK: 'ì†¡íŒŒì§€ì ',
      REG_DATE: '2025-10-15 16:00',
      CREATE_TIME: '2025-10-15 16:00',
      SEND_TIME: '2025-10-15 16:00',
      RSLT_TIME: '',
      TM_RSLT: 'ì‹¤íŒ¨'
    }
  ];
};

const getDummyWorkResultSignals = (): WorkResultSignal[] => {
  return [
    {
      WRK_DRCTN_ID: 'WRK001',
      WRK_ID: '1008409324',
      CUST_ID: 'CUST001',
      CUST_NM: 'ê¹€ì² ìˆ˜',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      CRR_ID: '01',
      CRR_NM: 'LG',
      PROD_CD: 'PROD001',
      PROD_NM: 'ì¸í„°ë„· 100M',
      WRK_CD: '02',
      WRK_CD_NM: 'A/S',
      WRK_STAT_CD: '4',
      WRK_STAT_NM: 'ì™„ë£Œ',
      SIGNAL_RESULT: 'ì •ìƒ',
      SIGNAL_DATE: '2025-10-16 15:30'
    },
    {
      WRK_DRCTN_ID: 'WRK002',
      WRK_ID: '1008409325',
      CUST_ID: 'CUST002',
      CUST_NM: 'ë°•ì˜í¬',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      CRR_ID: '01',
      CRR_NM: 'LG',
      PROD_CD: 'PROD002',
      PROD_NM: 'ì¸í„°ë„· 500M + TV',
      WRK_CD: '01',
      WRK_CD_NM: 'ì‹ ê·œì„¤ì¹˜',
      WRK_STAT_CD: '2',
      WRK_STAT_NM: 'ì§„í–‰ì¤‘',
      SIGNAL_RESULT: 'ëŒ€ê¸°ì¤‘'
    },
    {
      WRK_DRCTN_ID: 'WRK003',
      WRK_ID: '1008409326',
      CUST_ID: 'CUST003',
      CUST_NM: 'ì´ë¯¼ìˆ˜',
      SO_ID: '209',
      SO_NM: 'ì†¡íŒŒì§€ì ',
      CRR_ID: '01',
      CRR_NM: 'LG',
      PROD_CD: 'PROD003',
      PROD_NM: 'ì¸í„°ë„· 1G',
      WRK_CD: '03',
      WRK_CD_NM: 'ì´ì „ì„¤ì¹˜',
      WRK_STAT_CD: '1',
      WRK_STAT_NM: 'ëŒ€ê¸°',
      SIGNAL_RESULT: 'ë¯¸ì „ì†¡'
    }
  ];
};

// ì‘ì—…ì§€ì‹œì„œë³„ ì‹¤ì œ ì‘ì—…ê°œìˆ˜ ì¡°íšŒ
export const getWorkCountForDirection = async (directionId: string): Promise<number> => {
  try {
    const items = await getWorkReceipts(directionId);
    return items.length;
  } catch (error) {
    console.error('ì‘ì—…ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
    return 0;
  }
};

// ì‘ì—… ìƒì„¸ ëª©ë¡ ì¡°íšŒ API (receipts + directionId)
export const getWorkReceipts = async (directionId: string): Promise<any[]> => {
  console.log(`ğŸ“‹ Fetching work receipts for direction: ${directionId}...`);
  console.log('ğŸ” í˜„ì¬ ë”ë¯¸ ëª¨ë“œ:', checkDemoMode() ? 'ON' : 'OFF');

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  const isDemoMode = checkDemoMode();

  if (isDemoMode) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ í™œì„±í™”: ì‹¤ì œ API ëŒ€ì‹  ë”ë¯¸ ì‘ì—… ë°ì´í„° ë°˜í™˜');
    return getMockWorkItems(directionId);
  }

  console.log('ğŸš€ ì‹¤ì œ receipts API í˜¸ì¶œ ì‹œì‘');
  console.log('ğŸ“¡ API_BASE:', API_BASE);
  console.log('ğŸ“‹ ìš”ì²­ íŒŒë¼ë¯¸í„° (receipts + directionId):', { WRK_DRCTN_ID: directionId });

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetchWithRetry(`${API_BASE}/work/receipts`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify({
        WRK_DRCTN_ID: directionId
      }),
    });

    console.log('ğŸ“¡ receipts API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

    const apiData = await response.json();
    console.log('âœ… Receipts API ì„±ê³µ - ì‘ì—… ê°œìˆ˜:', apiData.length);
    console.log('ğŸ“Š ì²« ë²ˆì§¸ ì‘ì—…:', apiData[0]?.WRK_ID, apiData[0]?.WRK_CD_NM, apiData[0]?.CUST_NM);
    console.log('ğŸ“Š ì „ì²´ ì‘ì—… ëª©ë¡:', apiData.map(item => ({
      WRK_ID: item.WRK_ID,
      WRK_CD_NM: item.WRK_CD_NM,
      PROD_NM: item.PROD_NM,
      WRK_STAT_CD_NM: item.WRK_STAT_CD_NM
    })));
    return apiData;

  } catch (error) {
    console.error('âŒ receipts API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ì‘ì—…ì·¨ì†Œ API
export const cancelWork = async (cancelData: any): Promise<{ code: string; message: string }> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  const isDemoMode = typeof window !== 'undefined' && localStorage.getItem('demoMode') === 'true';
  
  if (isDemoMode) {
    console.log('ë”ë¯¸ ëª¨ë“œ: ì‘ì—…ì·¨ì†Œ ì‹œë®¬ë ˆì´ì…˜');
    // 1ì´ˆ ì§€ì—° í›„ ì„±ê³µ ì‘ë‹µ
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { code: "SUCCESS", message: "ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)" };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetch(`${API_BASE}/work/cancel`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(cancelData),
    });
    
    if (!response.ok) {
      throw new Error(`ì‘ì—…ì·¨ì†Œ ì‹¤íŒ¨: ${response.status}`);
    }
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('ì‘ì—…ì·¨ì†Œ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// API ì—”ë“œí¬ì¸íŠ¸: í™˜ê²½ë³„ ìµœì í™”
const API_BASE = typeof window !== 'undefined' ? (() => {
  const hostname = window.location.hostname;
  const protocol = window.location.protocol;
  
  console.log('ğŸ” í˜„ì¬ í™˜ê²½:', { hostname, protocol });
  
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://58.143.140.222:8080/api';  // ë¡œì»¬ â†’ ë”œë¼ì´ë¸Œ ë‚´ë¶€ì„œë²„
  } else if (hostname === '52.63.131.157') {
    // EC2 í™˜ê²½: Express í”„ë¡ì‹œ ì‚¬ìš© (ë”œë¼ì´ë¸Œ ë‚´ë¶€ì—ì„œë„ 8080 í¬íŠ¸ ì ‘ê·¼ ë¬¸ì œ)
    return '/api';  // EC2 Express ì„œë²„ì˜ í”„ë¡ì‹œ ì‚¬ìš©
  } else {
    return '/api';  // Vercel í”„ë¡ì‹œ
  }
})() : '/api';

// Helper function to map API's work type string to our enum
const mapWorkOrderType = (apiType: string): WorkOrderType => {
    switch (apiType) {
        case 'ì‹ ê·œì„¤ì¹˜': return WorkOrderType.Installation;
        case 'A/S': return WorkOrderType.AS;
        case 'ìƒí’ˆë³€ê²½': return WorkOrderType.Change;
        case 'ì´ì „ì„¤ì¹˜': return WorkOrderType.Move;
        default: return WorkOrderType.Etc;
    }
};

// Helper function to map API's work status string to our enum
const mapWorkOrderStatus = (apiStatus: string): WorkOrderStatus => {
    switch (apiStatus) {
        case 'ì§„í–‰ì¤‘': return WorkOrderStatus.Pending;
        case 'ì™„ë£Œ': return WorkOrderStatus.Completed;
        case 'ì·¨ì†Œ': return WorkOrderStatus.Cancelled;
        default: return WorkOrderStatus.Pending; // Default to pending if unknown
    }
};


export const getWorkOrders = async ({ startDate, endDate }: { startDate: string, endDate: string }): Promise<WorkOrder[]> => {
  console.log(`Fetching work orders from API for range: ${startDate} to ${endDate}...`);
  console.log('í˜„ì¬ ë”ë¯¸ ëª¨ë“œ:', checkDemoMode() ? 'ON' : 'OFF');

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  const isDemoMode = checkDemoMode();

  if (isDemoMode) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ í™œì„±í™”: ì‹¤ì œ API ëŒ€ì‹  ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    return getDummyWorkOrders(startDate, endDate);
  }

  const formattedStartDate = startDate.replace(/-/g, '');
  const formattedEndDate = endDate.replace(/-/g, '');

  const requestBody = {
    "WRKR_ID": "A20130708",
    "SO_ID": "209",
    "PROC_CL": "A02",
    "VIEW_TYP": "MOBILE",
    "SCH_HOPEDT_GB": "2",
    "PRT_STAT": "%",
    "WRK_DTL_TCD": "%",
    "HOPE_DT_STRT": formattedStartDate,
    "HOPE_DT_END": formattedEndDate,
    "PDA_WORK_STATUS": "2",
    "EMRG_YN": "",
    "WRK_CD": "",
    "DATE_GBN": ""
  };

  // ì‹¤ì œ ë”œë¼ì´ë¸Œ JSON API í˜¸ì¶œ
  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetchWithRetry(`${API_BASE}/work/directions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(requestBody),
    });

    const apiData = await response.json();

    // API ì‘ë‹µì´ ë¹ˆ ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (!Array.isArray(apiData) || apiData.length === 0) {
      return [];
    }

    // Transform the API data into the structure our app uses (WorkOrder[])
    const transformedData: WorkOrder[] = apiData.map((apiOrder: any) => {
      const date = apiOrder.HOPE_DT; // "20250923"
      const time = apiOrder.HOPE_TM; // "17:00"
      const scheduledAt = new Date(`${date.slice(0, 4)}-${date.slice(4, 6)}-${date.slice(6, 8)}T${time}:00`).toISOString();

      return {
        id: apiOrder.WRK_DRCTN_ID,
        type: mapWorkOrderType(apiOrder.WRK_CD_NM),
        typeDisplay: apiOrder.WRK_CD_NM || 'ê¸°íƒ€',
        status: mapWorkOrderStatus(apiOrder.WRK_STAT),
        scheduledAt: scheduledAt,
        customer: {
          id: apiOrder.CUST_ID,
          name: apiOrder.CUST_NM,
          address: apiOrder.ADDR,
        },
        details: apiOrder.REQ_CTX,
        assignedEquipment: [],
        directionId: apiOrder.WRK_DRCTN_ID
      };
    });

    console.log('Work orders transformed.');
    return transformedData;
  } catch (error) {
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì‘ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============ ì•ˆì „ì ê²€ API ============

export interface SafetyCheck {
  INSP_ID: string;
  SO_ID: string;
  CRR_ID: string;
  INSP_END_DT: string;
  STTL_YN: string;
  WRK_ID?: string;
  CUST_ID?: string;
  CUST_NM?: string;
  TEL_NO?: string;
  PASS_YN?: string;
  FAIL_GRADE?: string;
  DAPPR_RESN?: string;
  PROD_GRP_NM?: string;
}

/**
 * ì•ˆì „ì ê²€ ëª©ë¡ ì¡°íšŒ
 */
export const getSafetyChecks = async (params: { SO_ID: string; CRR_ID: string; INSP_DT_FROM?: string; INSP_DT_TO?: string; INSP_ID?: string }): Promise<SafetyCheck[]> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì•ˆì „ì ê²€ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 500)); // ë¡œë”© ì‹œë®¬ë ˆì´ì…˜
    return getDummySafetyChecks();
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const queryParams = new URLSearchParams();
    queryParams.append('SO_ID', params.SO_ID);
    queryParams.append('CRR_ID', params.CRR_ID);

    // ë‚ ì§œ ë²”ìœ„ íŒŒë¼ë¯¸í„° (í•„ìˆ˜)
    const today = new Date();
    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());

    const formatDate = (date: Date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    };

    const inspDtFrom = params.INSP_DT_FROM || formatDate(threeMonthsAgo);
    const inspDtTo = params.INSP_DT_TO || formatDate(today);

    queryParams.append('INSP_DT_FROM', inspDtFrom);
    queryParams.append('INSP_DT_TO', inspDtTo);

    if (params.INSP_ID) queryParams.append('INSP_ID', params.INSP_ID);

    const response = await fetch(`${API_BASE}/work/safety-checks?${queryParams.toString()}`, {
      method: 'GET',
      headers: {
        'Origin': origin
      },
      credentials: 'include',
    });

    if (!response.ok) {
      console.warn(`âš ï¸ ì•ˆì „ì ê²€ ì¡°íšŒ ì‹¤íŒ¨: ${response.status} - ê¸°ëŠ¥ì´ ì„œë²„ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤`);
      return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
    }

    const result = await response.json();
    return result;
  } catch (error) {
    console.warn('âš ï¸ ì•ˆì „ì ê²€ ì¡°íšŒ ì‹¤íŒ¨ - ë¹ˆ ê²°ê³¼ ë°˜í™˜:', error);
    return []; // ì—ëŸ¬ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
  }
};

/**
 * ì•ˆì „ì ê²€ ë“±ë¡
 */
export const saveSafetyCheck = async (data: {
  INSP_ID?: string;
  SO_ID: string;
  CRR_ID: string;
  INSP_END_DT: string;
  REG_UID: string;
}): Promise<{ code: string; message: string }> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì•ˆì „ì ê²€ ë“±ë¡ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { code: 'SUCCESS', message: 'ì•ˆì „ì ê²€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)' };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetch(`${API_BASE}/work/safety-check`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    
    if (!response.ok) {
      throw new Error(`ì•ˆì „ì ê²€ ë“±ë¡ ì‹¤íŒ¨: ${response.status}`);
    }
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('ì•ˆì „ì ê²€ ë“±ë¡ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// ============ ì‹ í˜¸ì—°ë™ê´€ë¦¬ API ============

export interface ENSHistory {
  MSG_TYP: string;
  SO_ID: string;
  SO_NM: string;
  EML_SMS_SND_ID: string;
  EML_SMS_SND_TP: string;
  EML_SMS_SND_TP_NM: string;
  CUST_ID: string;
  CUST_NM: string;
  SEND_TYPE: string;
  CELL_PHN: string;
  SMS_RCV_NO: string;
  MESSAGE: string;
  RESULT: string;
  RSLT_NM: string;
  REG_UID: string;
  REG_NM: string;
  SOSOK: string;
  REG_DATE: string;
  CREATE_TIME: string;
  SEND_TIME: string;
  RSLT_TIME: string;
  TM_RSLT: string;
  KKO_MSG_ID?: string;
  TBL_INFO?: string;
}

/**
 * ENS ì „ì†¡ ì´ë ¥ ì¡°íšŒ
 */
export const getENSHistory = async (params: {
  CUST_ID?: string;
  DEST_INFO?: string;
  REG_DATE1?: string;
  REG_DATE2?: string;
  RSLT_DATE1?: string;
  RSLT_DATE2?: string;
  SO_ID?: string;
  CRR_ID?: string;
  EML_SMS_SND_TP?: string;
  SMS_RESULT?: string;
  SMS_PROCESS?: string;
}): Promise<ENSHistory[]> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ENS ì´ë ¥ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return getDummyENSHistory();
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const queryParams = new URLSearchParams();

    Object.entries(params).forEach(([key, value]) => {
      if (value) queryParams.append(key, value);
    });

    const response = await fetch(`${API_BASE}/signal/ens-history?${queryParams.toString()}`, {
      method: 'GET',
      headers: {
        'Origin': origin
      },
      credentials: 'include',
    });

    if (!response.ok) {
      console.warn(`âš ï¸ ENS ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ${response.status} - ê¸°ëŠ¥ì´ ì„œë²„ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤`);
      return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
    }

    const result = await response.json();
    return result;
  } catch (error) {
    console.warn('âš ï¸ ENS ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨ - ë¹ˆ ê²°ê³¼ ë°˜í™˜:', error);
    return []; // ì—ëŸ¬ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
  }
};

// ============ ì‘ì—…ê²°ê³¼ì‹ í˜¸í˜„í™© API ============

export interface WorkResultSignal {
  WRK_DRCTN_ID: string;
  WRK_ID: string;
  CUST_ID: string;
  CUST_NM: string;
  SO_ID: string;
  SO_NM: string;
  CRR_ID: string;
  CRR_NM: string;
  PROD_CD: string;
  PROD_NM: string;
  WRK_CD: string;
  WRK_CD_NM: string;
  WRK_STAT_CD: string;
  WRK_STAT_NM: string;
  SIGNAL_RESULT?: string;
  SIGNAL_DATE?: string;
  ERROR_MSG?: string;
}

/**
 * ì‘ì—…ê²°ê³¼ì‹ í˜¸í˜„í™© ì¡°íšŒ
 */
export const getWorkResultSignals = async (params: {
  WRK_DRCTN_ID?: string;
  WRK_ID?: string;
  CUST_ID?: string;
  SO_ID?: string;
  CRR_ID?: string;
  PROD_CD?: string;
}): Promise<WorkResultSignal[]> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì‘ì—…ê²°ê³¼ì‹ í˜¸ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return getDummyWorkResultSignals();
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const queryParams = new URLSearchParams();

    Object.entries(params).forEach(([key, value]) => {
      if (value) queryParams.append(key, value);
    });

    const response = await fetch(`${API_BASE}/work/result-signals?${queryParams.toString()}`, {
      method: 'GET',
      headers: {
        'Origin': origin
      },
      credentials: 'include',
    });

    if (!response.ok) {
      console.warn(`âš ï¸ ì‘ì—…ê²°ê³¼ì‹ í˜¸ ì¡°íšŒ ì‹¤íŒ¨: ${response.status} - ê¸°ëŠ¥ì´ ì„œë²„ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤`);
      return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
    }

    const result = await response.json();
    return result;
  } catch (error) {
    console.warn('âš ï¸ ì‘ì—…ê²°ê³¼ì‹ í˜¸ ì¡°íšŒ ì‹¤íŒ¨ - ë¹ˆ ê²°ê³¼ ë°˜í™˜:', error);
    return []; // ì—ëŸ¬ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
  }
};

// ============ LGU ê´€ë ¨ API ============

export interface LGUConstructionRequest {
  WRK_ID: string;
  CUST_ID: string;
  CTRT_ID: string;
  CRR_ID: string;
  SO_ID: string;
  WRKR_ID: string;
  PROD_CD: string;
  REG_UID: string;
}

export interface LGUNetworkFault {
  CTRT_ID: string;
  CUST_ID: string;
  WRK_ID: string;
  CRR_ID: string;
  SO_ID: string;
  REG_UID: string;
  CANCEL_TYPE?: string;
}

/**
 * LGU ê³µì‚¬ìš”ì²­ì§„í–‰ì •ë³´ (LDAP ìš”ì²­)
 */
export const requestLGUConstruction = async (data: LGUConstructionRequest): Promise<any> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: LGU ê³µì‚¬ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1500));
    return [{ 
      code: 'SUCCESS', 
      message: 'LGU ê³µì‚¬ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)',
      REQUEST_ID: 'LGU' + Date.now(),
      STATUS: 'ì ‘ìˆ˜ì™„ë£Œ'
    }];
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetch(`${API_BASE}/lgu/construction-request`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    
    if (!response.ok) {
      throw new Error(`LGU ê³µì‚¬ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
    }
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('LGU ê³µì‚¬ìš”ì²­ ì‹¤íŒ¨:', error);
    throw error;
  }
};

/**
 * LGU ë§ì¥ì• ì´ê´€ë¦¬ìŠ¤íŠ¸ (ì—”íŠ¸ ì²˜ë¦¬ ì·¨ì†Œ)
 */
export const requestLGUNetworkFault = async (data: LGUNetworkFault): Promise<any> => {
  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: LGU ë§ì¥ì•  ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1500));
    return [{
      code: 'SUCCESS',
      message: 'LGU ë§ì¥ì•  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)',
      CANCEL_ID: 'FAULT' + Date.now(),
      STATUS: 'ì·¨ì†Œì™„ë£Œ'
    }];
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetch(`${API_BASE}/lgu/network-fault`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      throw new Error(`LGU ë§ì¥ì•  ì²˜ë¦¬ ì‹¤íŒ¨: ${response.status}`);
    }

    const result = await response.json();
    return result;
  } catch (error) {
    console.error('LGU ë§ì¥ì•  ì²˜ë¦¬ ì‹¤íŒ¨:', error);
    throw error;
  }
};

// ============ ì¥ë¹„ ê´€ë¦¬ API ============

/**
 * ì¥ë¹„ ì •ë³´ ì¸í„°í˜ì´ìŠ¤
 */
export interface EquipmentInfo {
  EQT_ID: string;           // ì¥ë¹„ ID
  EQT_TP_CD: string;        // ì¥ë¹„ ìœ í˜• ì½”ë“œ
  EQT_TP_NM: string;        // ì¥ë¹„ ìœ í˜•ëª… (ëª¨ë€, ì…‹í†±ë°•ìŠ¤ ë“±)
  EQT_MDL_CD: string;       // ì¥ë¹„ ëª¨ë¸ ì½”ë“œ
  EQT_MDL_NM: string;       // ì¥ë¹„ ëª¨ë¸ëª…
  SRLNO: string;            // ì‹œë¦¬ì–¼ë²ˆí˜¸
  MAC_ADDR?: string;        // MAC ì£¼ì†Œ
  INSTL_LCTN?: string;      // ì„¤ì¹˜ ìœ„ì¹˜
  ITEM_MID_CD?: string;     // í’ˆëª© ì¤‘ë¶„ë¥˜ ì½”ë“œ (04:ëª¨ë€, 05:ì…‹í†±ë°•ìŠ¤, 07:íŠ¹ìˆ˜ì¥ë¹„, 03:ì¶”ê°€ì¥ë¹„)
  WRKR_ID?: string;         // ê¸°ì‚¬ ID
  SO_ID?: string;           // ì§€ì  ID
  CRR_ID?: string;          // í†µì‹ ì‚¬ ID
}

/**
 * ì¥ë¹„ ì •ë³´ ì¡°íšŒ ì‘ë‹µ íƒ€ì…
 */
export interface EquipmentQueryResponse {
  contractEquipments: any[];      // output2: ê³„ì•½ ì¥ë¹„ (ì„¤ì¹˜í•´ì•¼ í•  ì¥ë¹„)
  technicianEquipments: any[];    // output3: ê¸°ì‚¬ ì¬ê³  ì¥ë¹„
  customerEquipments: any[];      // output4: ê³ ê° ì„¤ì¹˜ ì¥ë¹„
  removedEquipments: any[];       // output5: íšŒìˆ˜ ì¥ë¹„
}

/**
 * ê¸°ì‚¬ ë³´ìœ  ì¥ë¹„ ì¡°íšŒ (ì‹¤ì œë¡œëŠ” output2~5ë¥¼ ëª¨ë‘ ë°˜í™˜)
 * @param params - ê¸°ì‚¬ ID, ì§€ì  ID, ìƒí’ˆ ì½”ë“œ ë“±
 */
export const getTechnicianEquipments = async (params: {
  WRKR_ID: string;          // ê¸°ì‚¬ ID
  SO_ID?: string;           // ì§€ì  ID (ì„ íƒ, ë¯¸ì§€ì • ì‹œ SO í•„í„° í•´ì œ)
  WORK_ID?: string;         // ì‘ì—… ID
  PROD_CD?: string;         // ìƒí’ˆ ì½”ë“œ (íŠ¹ì • ìƒí’ˆì— ë§ëŠ” ì¥ë¹„ë§Œ ì¡°íšŒ)
  CUST_ID?: string;         // ê³„ì•½ ID
  CRR_TSK_CL?: string;      // ì‘ì—… ìœ í˜• ì½”ë“œ (01:ì‹ ê·œì„¤ì¹˜, 05:ì´ì „ì„¤ì¹˜, 07:ìƒí’ˆë³€ê²½, 09:AS ë“±)
  WRK_DTL_TCD?: string;     // ì‘ì—… ìƒì„¸ íƒ€ì… ì½”ë“œ
  CTRT_ID?: string;         // ê³„ì•½ ID (ë ˆê±°ì‹œ ëª…ì¹­)
  RCPT_ID?: string;         // ì ‘ìˆ˜ ID
  CRR_ID?: string;          // ê¶Œì—­/í†µì‹ ì‚¬ ID
  ADDR_ORD?: string;        // ì£¼ì†Œ ìˆœë²ˆ
  WRK_CD?: string;          // ì‘ì—… ì½”ë“œ
  WRK_STAT_CD?: string;     // ì‘ì—… ìƒíƒœ ì½”ë“œ
  WRK_DRCTN_ID?: string;    // ì‘ì—…ì§€ì‹œ ID
  BLD_ID?: string;          // ê±´ë¬¼ ID
}): Promise<EquipmentQueryResponse> => {
  console.log('ğŸ“¦ ê¸°ì‚¬ ë³´ìœ  ì¥ë¹„ ì¡°íšŒ API í˜¸ì¶œ:', params);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬ ë˜ëŠ” ì‹¤ì œ ì¥ë¹„ê°€ ì—†ì„ ë•Œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
  const isDemoMode = checkDemoMode();

  console.log('ğŸ” ë”ë¯¸ ëª¨ë“œ:', isDemoMode ? 'ON' : 'OFF');
  console.log('ğŸ“Š SQL ì¡°ê±´ ìš”ì•½:');
  console.log('  - WRKR_ID =', params.WRKR_ID);
  console.log('  - SO_ID =', params.SO_ID);
  console.log('  - EQT_LOC_TP_CD = 3 (ì‘ì—…ê¸°ì‚¬ ìœ„ì¹˜)');
  console.log('  - EQT_STAT_CD IN (10, 80) (ì •ìƒ/ì„ì‹œì¶œê³ )');
  console.log('  - EQT_USE_ARR_YN = Y (ì‚¬ìš©ê°€ëŠ¥)');
  console.log('  - NOT EXISTS (ì´ë¯¸ ê³ ê°ì— í• ë‹¹ëœ ì¥ë¹„ ì œì™¸)');

  if (isDemoMode) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ê¸°ì‚¬ ì¥ë¹„ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return {
      contractEquipments: [
        {
          SVC_CMPS_ID: 'SVC001',
          ITEM_MID_NM: 'ëª¨ë€',
          EQT_CL_NM: 'RS-M100',
          ITEM_MID_CD: '04',
        },
        {
          SVC_CMPS_ID: 'SVC002',
          ITEM_MID_NM: 'ì…‹í†±ë°•ìŠ¤',
          EQT_CL_NM: 'DTV-STB100',
          ITEM_MID_CD: '05',
        }
      ],
      technicianEquipments: [
        {
          EQT_NO: 'EQT001',
          ITEM_MID_NM: 'ëª¨ë€',
          EQT_CL_NM: 'RS-M100',
          EQT_SERNO: 'RSM100001',
          ITEM_MID_CD: '04',
          MAC_ADDRESS: 'AA:BB:CC:DD:EE:01'
        },
        {
          EQT_NO: 'EQT002',
          ITEM_MID_NM: 'ëª¨ë€',
          EQT_CL_NM: 'RS-M200',
          EQT_SERNO: 'RSM200001',
          ITEM_MID_CD: '04',
          MAC_ADDRESS: 'AA:BB:CC:DD:EE:02'
        },
        {
          EQT_NO: 'EQT003',
          ITEM_MID_NM: 'ì…‹í†±ë°•ìŠ¤',
          EQT_CL_NM: 'DTV-STB100',
          EQT_SERNO: 'DTV100001',
          ITEM_MID_CD: '05',
        },
        {
          EQT_NO: 'EQT004',
          ITEM_MID_NM: 'ì…‹í†±ë°•ìŠ¤',
          EQT_CL_NM: 'DTV-STB200',
          EQT_SERNO: 'DTV200001',
          ITEM_MID_CD: '05',
        }
      ],
      customerEquipments: [],
      removedEquipments: []
    };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';

    // ë ˆê±°ì‹œì™€ ë™ì¼í•œ íŒŒë¼ë¯¸í„° êµ¬ì„±
    const requestParams = {
      ...params,
      EQT_SEL: '0',      // ë ˆê±°ì‹œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°
      EQT_CL: 'ALL'      // ë ˆê±°ì‹œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°
    };

    console.log('\nğŸš€ ==========================================');
    console.log('ğŸš€ ì¥ë¹„ ì¡°íšŒ API í˜¸ì¶œ ì‹œì‘');
    console.log('ğŸš€ ==========================================');
    console.log('\nğŸ“¤ ì „ì†¡í•  íŒŒë¼ë¯¸í„° (JSON):');
    console.log(JSON.stringify(requestParams, null, 2));

    console.log('\nğŸ” í•µì‹¬ íŒŒë¼ë¯¸í„° í™•ì¸:');
    console.log('  â”œâ”€ WRKR_ID (ê¸°ì‚¬ID):', requestParams.WRKR_ID);
    console.log('  â”œâ”€ SO_ID (ì§€ì ID):', requestParams.SO_ID);
    console.log('  â”œâ”€ CRR_TSK_CL (ì‘ì—…ë¶„ë¥˜):', requestParams.CRR_TSK_CL);
    console.log('  â”œâ”€ WRK_DTL_TCD (ì‘ì—…ìƒì„¸):', requestParams.WRK_DTL_TCD);
    console.log('  â”œâ”€ CUST_ID (ê³ ê°ID):', requestParams.CUST_ID);
    console.log('  â”œâ”€ CTRT_ID (ê³„ì•½ID):', requestParams.CTRT_ID);
    console.log('  â”œâ”€ WRK_CD (ì‘ì—…ì½”ë“œ):', requestParams.WRK_CD);
    console.log('  â”œâ”€ WRK_STAT_CD (ì‘ì—…ìƒíƒœ):', requestParams.WRK_STAT_CD);
    console.log('  â”œâ”€ PROD_CD (ìƒí’ˆì½”ë“œ):', requestParams.PROD_CD);
    console.log('  â””â”€ EQT_CL (ì¥ë¹„ë¶„ë¥˜):', requestParams.EQT_CL);

    console.log('\nâš ï¸ ë ˆê±°ì‹œ ë¡œì§ ë¶„ì„:');
    console.log(`  CRR_TSK_CL="${requestParams.CRR_TSK_CL}" ì¼ ë•Œ:`);
    if (['01','05','07','09'].includes(requestParams.CRR_TSK_CL || '')) {
      console.log('  âœ… output3 (ê¸°ì‚¬ì¥ë¹„)ê°€ ë°˜í™˜ë˜ì–´ì•¼ í•¨');
      console.log('  âœ… SQL: workmanAssignDao.getWrkrEqtInfo(map) ì‹¤í–‰');
    } else {
      console.log('  âš ï¸ output3 (ê¸°ì‚¬ì¥ë¹„)ê°€ ë°˜í™˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ');
    }
    console.log('==========================================\n');

    const response = await fetchWithRetry(`${API_BASE}/customer/work/getCustProdInfo`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(requestParams),
    });

    const result = await response.json();

    console.log('\nğŸ“¥ ==========================================');
    console.log('ğŸ“¥ í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì‹  ì‘ë‹µ');
    console.log('ğŸ“¥ ==========================================');
    console.log('ğŸ“Š ì‘ë‹µ ë°ì´í„° ê°œìˆ˜:');
    console.log('  â”œâ”€ output1 (í”„ë¡œëª¨ì…˜):', result?.output1?.length || 0, 'ê°œ');
    console.log('  â”œâ”€ output2 (ê³„ì•½ì¥ë¹„):', result?.output2?.length || 0, 'ê°œ');
    console.log('  â”œâ”€ output3 (ê¸°ì‚¬ì¥ë¹„):', result?.output3?.length || 0, 'ê°œ');
    console.log('  â”œâ”€ output4 (ê³ ê°ì¥ë¹„):', result?.output4?.length || 0, 'ê°œ');
    console.log('  â””â”€ output5 (íšŒìˆ˜ì¥ë¹„):', result?.output5?.length || 0, 'ê°œ');
    console.log('==========================================\n');

    // API ì‘ë‹µì€ { output1: [], output2: [], output3: [], output4: [], output5: [] } í˜•íƒœ
    // output1 = í”„ë¡œëª¨ì…˜ ì •ë³´ (getProdPromotionInfo)
    // output2 = ê³„ì•½/ìƒí’ˆì— í¸ì„±ëœ ì¥ë¹„ (getEqtProdInfo) â† ì„¤ì¹˜í•´ì•¼ í•  ì¥ë¹„ ëª©ë¡!
    // output3 = ê¸°ì‚¬ ë³´ìœ  ì¥ë¹„ (getWrkrEqtInfo) â† ê¸°ì‚¬ ì¬ê³ 
    // output4 = ê³ ê° ì„¤ì¹˜ ì¥ë¹„ (getCustInstlEqtInfo with CUST_EQT='USE')
    // output5 = ê³ ê° íšŒìˆ˜ ì¥ë¹„ (getCustInstlEqtInfo with CUST_EQT='REMOVE')

    // âš ï¸ ì¤‘ìš”: ë‹ˆë§ˆì´í”Œë«í¼ ë¡œì§
    // - output2 (ê³„ì•½ì¥ë¹„): ê³„ì•½ì— ë“±ë¡ëœ "ì„¤ì¹˜í•´ì•¼ í• " ì¥ë¹„ ëª©ë¡
    // - output3 (ê¸°ì‚¬ì¬ê³ ): ê¸°ì‚¬ê°€ ë³´ìœ í•œ "ì‹¤ì œ ì¬ê³ " ì¥ë¹„
    // - í™”ë©´ì—ì„œëŠ” output2 + output3ì„ ëª¨ë‘ í‘œì‹œí•´ì•¼ í•¨!

    return {
      contractEquipments: result?.output2 || [],    // ê³„ì•½ ì¥ë¹„ (ì„¤ì¹˜ ëŒ€ìƒ)
      technicianEquipments: result?.output3 || [],  // ê¸°ì‚¬ ì¬ê³ 
      customerEquipments: result?.output4 || [],    // ê³ ê° ì„¤ì¹˜ ì¥ë¹„
      removedEquipments: result?.output5 || []      // íšŒìˆ˜ ì¥ë¹„
    };
  } catch (error) {
    console.error('âŒ ì¥ë¹„ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì¥ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * ì¥ë¹„ êµ¬ì„± ì •ë³´ ì¡°íšŒ (ê³„ì•½ì— í¸ì„±ëœ ì¥ë¹„)
 */
export const getContractEquipments = async (params: {
  CUST_ID: string;          // ê³„ì•½ ID
  PROD_CD?: string;         // ìƒí’ˆ ì½”ë“œ
}): Promise<EquipmentInfo[]> => {
  console.log('ğŸ“‹ ì¥ë¹„ êµ¬ì„± ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ:', params);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ê³„ì•½ ì¥ë¹„ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return [];
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetchWithRetry(`${API_BASE}/customer/work/getCustProdInfo`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify({
        ...params,
        requestType: 'getEqtProdInfo' // ì¥ë¹„ êµ¬ì„± ì •ë³´ ì¡°íšŒ íƒ€ì…
      }),
    });

    const result = await response.json();
    console.log('âœ… ì¥ë¹„ êµ¬ì„± ì •ë³´ ì¡°íšŒ ì„±ê³µ:', result);
    return result;
  } catch (error) {
    console.error('âŒ ì¥ë¹„ êµ¬ì„± ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì¥ë¹„ êµ¬ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * ê³ ê° ì¥ë¹„ ë“±ë¡ (ì‘ì—… ì™„ë£Œ ì‹œ ì¥ë¹„ ì •ë³´ í¬í•¨)
 * ì‘ì—… ì™„ë£Œ API í˜¸ì¶œ ì‹œ datasetì— ì¥ë¹„ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì „ì†¡
 */
export interface CustomerEquipmentRegistration {
  EQT_ID: string;           // ì¥ë¹„ ID
  SRLNO: string;            // ì‹œë¦¬ì–¼ë²ˆí˜¸
  MAC_ADDR?: string;        // MAC ì£¼ì†Œ (ëª¨ë€ì˜ ê²½ìš° í•„ìˆ˜)
  INSTL_LCTN?: string;      // ì„¤ì¹˜ ìœ„ì¹˜
  ITEM_MID_CD: string;      // í’ˆëª© ì¤‘ë¶„ë¥˜ ì½”ë“œ
  EQT_TP_CD: string;        // ì¥ë¹„ ìœ í˜• ì½”ë“œ
  EQT_MDL_CD: string;       // ì¥ë¹„ ëª¨ë¸ ì½”ë“œ
}

/**
 * ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½
 * @param data - ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½ ìš”ì²­ ë°ì´í„°
 */
export const updateEquipmentComposition = async (data: {
  WRK_ID: string;
  equipments: any[];
  RCPT_ID?: string;
  CTRT_ID?: string;
  PROM_CNT?: string; // ëª¨ë‹¬ì—ì„œ ì„ íƒí•œ ì•½ì • ê°œì›”
  CUST_ID?: string;  // ë ˆê±°ì‹œ ê¸°ì¤€ ë¶ˆí•„ìš”(ì˜µì…˜ìœ¼ë¡œ ì „í™˜)
}): Promise<{ code: string; message: string }> => {
  console.log('ğŸ”„ ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½ API í˜¸ì¶œ:', data);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì¥ë¹„ êµ¬ì„± ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { code: 'SUCCESS', message: 'ì¥ë¹„ êµ¬ì„±ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)' };
  }

  try {
    console.log('=====================================================');
    console.log('ğŸš€ [modifyEquipmentComposition] ì‹œì‘');
    console.log('  ì „ë‹¬ë°›ì€ data:', data);
    console.log('  data.equipments:', data.equipments);
    console.log('=====================================================');

    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    // miPlatform ìŠ¤íƒ€ì¼ ëˆ„ì  í•„ë“œ ìƒì„± (mowoa03p20.xmlê³¼ ë™ì¼ ë¡œì§)
    const rpad = (s: any, len: number, ch: string) => {
      const str = (s == null ? '' : String(s)).trim();
      if (str.length >= len) return str.substring(0, len);
      return str + new Array(len - str.length + 1).join(ch);
    };
    let PROD_GRPS = '';
    let PROD_CMPS_CLS = '';
    let PROD_CDS = '';
    let SVC_CDS = '';
    let ITEM_MID_CDS = '';
    let EQT_CLS = '';
    let LENTS = '';
    let EQT_USE_STATS = '';
    let EQT_SALE_AMTS = '';
    let ITLLMT_PRDS = '';
    let SERVICE_CNT = 0;

    console.log('-----------------------------------------------------');
    console.log('ğŸ“‹ ì„ íƒëœ ì¥ë¹„ í•„í„°ë§ ì „:', data.equipments?.length, 'ê°œ');

    // ë ˆê±°ì‹œ ê·¸ë¦¬ë“œì™€ ë™ì¼í•˜ê²Œ ì¥ë¹„ ìˆœì„œë¥¼ EQUIP_SEQ/SVC_CMPS_ID ê¸°ì¤€ìœ¼ë¡œ ì•ˆì •í™”
    const selectedOrdered = (data.equipments || [])
      .filter((eq: any) => {
        const sel = String((eq as any).SEL || '1');
        console.log(`  ì¥ë¹„ í•„í„°ë§: EQT=${eq.EQT}, SEL=${sel}, ì„ íƒ=${sel === '1'}`);
        return sel === '1';
      })
      .map((eq: any, idx: number) => ({ eq, order: Number((eq as any).EQUIP_SEQ || (eq as any).SVC_CMPS_ID || (idx + 1)), idx }))
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    console.log('âœ… ì„ íƒëœ ì¥ë¹„:', selectedOrdered.length, 'ê°œ');
    console.log('-----------------------------------------------------');

    for (let i = 0; i < selectedOrdered.length; i++) {
      const { eq, idx } = selectedOrdered[i];
      console.log(`\n[ì¥ë¹„ ${i + 1}/${selectedOrdered.length}]`);
      // ì„ íƒëœ ì¥ë¹„(SEL === '1')ë§Œ ëˆ„ì  - ë ˆê±°ì‹œ íŒì—… ì €ì¥ê³¼ ë™ì¼
      console.log('ğŸ” ì¥ë¹„ ë°ì´í„°:', {
        PROD_GRP: (eq as any).PROD_GRP,
        PROD_TYP: (eq as any).PROD_TYP,
        EQUIP_SEQ: (eq as any).EQUIP_SEQ,
        SVC_CMPS_ID: (eq as any).SVC_CMPS_ID,
        PROD_CD: (eq as any).PROD_CD,
        SVC_CD: (eq as any).SVC_CD,
        ITEM_MID_CD: (eq as any).ITEM_MID_CD,
        EQT: (eq as any).EQT,
        EQT_CD: (eq as any).EQT_CD,
        EQT_CL: (eq as any).EQT_CL,
        EQT_CL_CD: (eq as any).EQT_CL_CD,
        LENT: (eq as any).LENT,
        EQT_USE_STAT_CD: (eq as any).EQT_USE_STAT_CD,
        EQT_SALE_AMT: (eq as any).EQT_SALE_AMT,
        ITLLMT_PRD: (eq as any).ITLLMT_PRD
      });

      const prodGrp = String((eq as any).PROD_GRP || '');
      PROD_GRPS += prodGrp;
      console.log('  PROD_GRP:', prodGrp, 'â†’ PROD_GRPS:', PROD_GRPS);

      // â­ï¸ [ìµœì¢…ìˆ˜ì •] ë ˆê±°ì‹œì™€ ì™„ì „íˆ ë™ì¼í•˜ê²Œ: íŒ¨ë”© ì—†ì´ ê·¸ëŒ€ë¡œ ì—°ê²°
      // ë ˆê±°ì‹œ: prod_cmps_cls += PROD_TYP + EQUIP_SEQ (íŒ¨ë”© ì—†ìŒ)
      const prodTypRaw = (eq as any).PROD_TYP;
      const equipSeqRaw = (eq as any).EQUIP_SEQ || (eq as any).SVC_CMPS_ID;

      const prodTyp = String(prodTypRaw || '');
      const equipSeq = String(equipSeqRaw || '');

      console.log('  PROD_TYP ì›ë³¸:', prodTypRaw, '(íƒ€ì…:', typeof prodTypRaw, ')');
      console.log('  EQUIP_SEQ ì›ë³¸:', equipSeqRaw, '(íƒ€ì…:', typeof equipSeqRaw, ')');
      console.log('  PROD_TYP ë³€í™˜:', prodTyp, '(ê¸¸ì´:', prodTyp.length, ')');
      console.log('  EQUIP_SEQ ë³€í™˜:', equipSeq, '(ê¸¸ì´:', equipSeq.length, ')');

      const beforeCmps = PROD_CMPS_CLS;
      PROD_CMPS_CLS += prodTyp + equipSeq;
      console.log(`  âœ… PROD_CMPS_CLS: "${beforeCmps}" + "${prodTyp}${equipSeq}" = "${PROD_CMPS_CLS}"`);

      PROD_CDS += String((eq as any).PROD_CD || '');
      SVC_CDS += String((eq as any).SVC_CD || '');

      const itemMidCd = rpad((eq as any).ITEM_MID_CD || (eq as any).EQT || (eq as any).EQT_CD || '', 10, ' ');
      ITEM_MID_CDS += itemMidCd;
      console.log('  ITEM_MID_CD:', itemMidCd.trim(), 'â†’ ITEM_MID_CDS ê¸¸ì´:', ITEM_MID_CDS.length);

      const eqtCl = rpad((eq as any).EQT_CL || (eq as any).EQT_CL_CD || '', 10, ' ');
      EQT_CLS += eqtCl;
      console.log('  EQT_CL:', eqtCl.trim(), 'â†’ EQT_CLS ê¸¸ì´:', EQT_CLS.length);

      // â­ï¸ [ìµœì¢…ìˆ˜ì •] ë ˆê±°ì‹œì™€ ì™„ì „íˆ ë™ì¼í•˜ê²Œ: LENT íŒ¨ë”© ì—†ì´ ê·¸ëŒ€ë¡œ ì—°ê²°
      const lent = String((eq as any).LENT || '');
      LENTS += lent;
      console.log('  LENT:', lent, 'â†’ LENTS:', LENTS);

      // â­ï¸ [ìµœì¢…ìˆ˜ì •] ë ˆê±°ì‹œì™€ ì™„ì „íˆ ë™ì¼í•˜ê²Œ: EQT_USE_STAT_CDë¥¼ 1ìë¦¬ë¡œ rpad
      const eqtUseStat = rpad(String((eq as any).EQT_USE_STAT_CD || ''), 1, ' ');
      EQT_USE_STATS += eqtUseStat;
      console.log('  EQT_USE_STAT_CD:', eqtUseStat, 'â†’ EQT_USE_STATS:', EQT_USE_STATS);

      // â­ï¸ [ìˆ˜ì •] EQT_SALE_AMTSëŠ” ë ˆê±°ì‹œì²˜ëŸ¼ ë®ì–´ì“°ê¸° (ëˆ„ì  ì•„ë‹˜)
      EQT_SALE_AMTS = rpad((eq as any).EQT_SALE_AMT || 0, 10, ' ');

      const itllmtPrd = rpad((eq as any).ITLLMT_PRD || '00', 2, ' ');
      ITLLMT_PRDS += itllmtPrd;
      console.log('  ITLLMT_PRD:', itllmtPrd.trim(), 'â†’ ITLLMT_PRDS ê¸¸ì´:', ITLLMT_PRDS.length);

      SERVICE_CNT += 1;
    }

    console.log('\n=====================================================');
    console.log('ğŸ“¦ íŒŒë¼ë¯¸í„° ìƒì„± ì™„ë£Œ');
    console.log('  SERVICE_CNT:', SERVICE_CNT);
    console.log('  PROD_GRPS:', PROD_GRPS);
    console.log('  PROD_CMPS_CLS:', PROD_CMPS_CLS, '(ê¸¸ì´:', PROD_CMPS_CLS.length, ')');
    console.log('  PROD_CDS ê¸¸ì´:', PROD_CDS.length);
    console.log('  SVC_CDS ê¸¸ì´:', SVC_CDS.length);
    console.log('  ITEM_MID_CDS ê¸¸ì´:', ITEM_MID_CDS.length);
    console.log('  EQT_CLS ê¸¸ì´:', EQT_CLS.length);
    console.log('  LENTS:', LENTS);
    console.log('  EQT_USE_STATS:', EQT_USE_STATS);
    console.log('  ITLLMT_PRDS ê¸¸ì´:', ITLLMT_PRDS.length);
    console.log('=====================================================');
    // â­ï¸ [ìˆ˜ì •] ë ˆê±°ì‹œ ì •í™•íˆ ì¼ì¹˜ì‹œí‚¤ê¸° - CRR_ID, WRKR_ID, REG_UID ì œê±° (ì„œë²„ì—ì„œ ì„¸ì…˜ìœ¼ë¡œ ì²˜ë¦¬)
    const parameters = {
      RCPT_ID: data.RCPT_ID || '',
      WRK_ID: data.WRK_ID,
      CTRT_ID: data.CTRT_ID || '',
      PROD_GRPS,
      PROD_CMPS_CLS,
      PROD_CDS,
      SVC_CDS,
      ITEM_MID_CDS,
      EQT_CLS,
      LENTS,
      EQT_USE_STATS,
      EQT_SALE_AMTS,
      ITLLMT_PRDS,
      SERVICE_CNT: String(SERVICE_CNT),
      PROM_CNT: data.PROM_CNT || '',
    };

    console.log('\nğŸš€ğŸš€ğŸš€ ìµœì¢… ì „ì†¡ íŒŒë¼ë¯¸í„° ğŸš€ğŸš€ğŸš€');
    console.log('parameters:', JSON.stringify(parameters, null, 2));
    console.log('ê° í•„ë“œ ìƒì„¸:');
    console.log('  PROD_CMPS_CLS:', `"${PROD_CMPS_CLS}"`, '(ê¸¸ì´:', PROD_CMPS_CLS.length, ')');
    console.log('  EQT_USE_STATS:', `"${EQT_USE_STATS}"`, '(ê¸¸ì´:', EQT_USE_STATS.length, ')');
    console.log('  ITLLMT_PRDS:', `"${ITLLMT_PRDS}"`, '(ê¸¸ì´:', ITLLMT_PRDS.length, ')');
    console.log('  ITEM_MID_CDS:', `"${ITEM_MID_CDS}"`, '(ê¸¸ì´:', ITEM_MID_CDS.length, ')');
    console.log('  EQT_CLS:', `"${EQT_CLS}"`, '(ê¸¸ì´:', EQT_CLS.length, ')');
    console.log('  LENTS:', `"${LENTS}"`, '(ê¸¸ì´:', LENTS.length, ')');
    console.log('=====================================================\n');

    // ì¬ì‹œë„ ì—†ì´ 1íšŒ í˜¸ì¶œ (fetchWithRetry ì œê±°)
    console.log('ğŸ“¡ API í˜¸ì¶œ ì‹œì‘:', `${API_BASE}/customer/work/eqtCmpsInfoChg`);
    const response = await fetch(`${API_BASE}/customer/work/eqtCmpsInfoChg`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      // ë ˆê±°ì‹œ í˜¸í™˜: equipments/WRK_ID ë“±ì˜ ìƒìœ„ í‚¤ëŠ” ì œì™¸í•˜ê³  parametersë§Œ ì „ì†¡
      body: JSON.stringify({ parameters }),
    });

    if (!response.ok) {
      // 500 ë“± ì—ëŸ¬ ë³¸ë¬¸ì„ MESSAGEë¡œ ë³€í™˜
      let msg = `HTTP ${response.status}: ${response.statusText}`;
      try {
        const errJson = await response.json();
        msg = errJson.MESSAGE || errJson.message || msg;
      } catch {
        try {
          const txt = await response.text();
          if (txt) msg = txt;
        } catch {}
      }
      throw new NetworkError(msg);
    }

    const result = await response.json();
    console.log('âœ… ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½ ì„±ê³µ:', result);
    return result;
  } catch (error) {
    console.error('âŒ ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì¥ë¹„ êµ¬ì„± ì •ë³´ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * ìƒí’ˆë³„ ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
 * Legacy: /customer/receipt/contract/getEquipmentNmListOfProd.req
 * @param prodCd - ìƒí’ˆ ì½”ë“œ
 * @param ctrtId - ê³„ì•½ ID (ì„ íƒ)
 * @returns ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ (EQT_CD, EQT_CL_CD, EQT_CL_NM)
 */
export const getEquipmentModelsForProduct = async (
  prodCd: string,
  ctrtId?: string
): Promise<Array<{
  EQT_CD: string;      // ITEM_MID_CD (04:ëª¨ë€, 05:ì…‹í†±ë°•ìŠ¤ ë“±)
  EQT_CL_CD: string;   // ì¥ë¹„ í´ë˜ìŠ¤ ì½”ë“œ (ëª¨ë¸ ì½”ë“œ)
  EQT_CL_NM: string;   // ì¥ë¹„ í´ë˜ìŠ¤ëª… (ëª¨ë¸ëª…)
}>> => {
  console.log('ğŸ” ìƒí’ˆë³„ ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ API í˜¸ì¶œ:');
  console.log('  - PROD_CD:', prodCd);
  console.log('  - CTRT_ID:', ctrtId);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return [
      { EQT_CD: '05', EQT_CL_CD: 'STB001', EQT_CL_NM: 'STB-HD' },
      { EQT_CD: '05', EQT_CL_CD: 'STB002', EQT_CL_NM: 'STB-UHD' },
      { EQT_CD: '05', EQT_CL_CD: 'STB003', EQT_CL_NM: 'STB-4K' },
      { EQT_CD: '04', EQT_CL_CD: 'MDM001', EQT_CL_NM: 'DOCSIS 3.0' },
      { EQT_CD: '04', EQT_CL_CD: 'MDM002', EQT_CL_NM: 'DOCSIS 3.1' },
    ];
  }

  try {
    const requestBody: any = {
      EQT_SEL: "0",           // ë ˆê±°ì‹œì™€ ë™ì¼: ê³ ì •ê°’
      PROD_CD: prodCd,
      BUGA_EQT_SEL: "Y",      // ë ˆê±°ì‹œì™€ ë™ì¼: ê³ ì •ê°’
    };

    if (ctrtId) {
      requestBody.CTRT_ID = ctrtId;
    }

    console.log('ğŸ“¤ ìš”ì²­ ë°ì´í„° (ë ˆê±°ì‹œ 4ê°œ íŒŒë¼ë¯¸í„°):', requestBody);

    const response = await fetch(`${API_BASE}/customer/receipt/contract/getEquipmentNmListOfProd`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    console.log('ğŸ“¥ getEquipmentNmListOfProd ì‘ë‹µ ë°ì´í„°:', data);
    console.log('ğŸ“¥ ì‘ë‹µ íƒ€ì…:', typeof data, 'isArray:', Array.isArray(data));

    // ë°±ì—”ë“œì—ì„œ Listë¥¼ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ data ìì²´ê°€ ë°°ì—´
    if (Array.isArray(data)) {
      console.log('âœ… ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸:', data.length, 'ê°œ');
      return data;
    }

    // ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
    if (data.code && data.message) {
      throw new Error(data.message || 'ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨');
    }

    throw new Error('ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ì˜ëª»ëœ ì‘ë‹µ í˜•ì‹');
  } catch (error) {
    console.error('âŒ ì¥ë¹„ ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ API ì—ëŸ¬:', error);
    throw error;
  }
};

// ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ íƒ€ì… ì •ì˜
export interface ContractEquipment {
  SEL?: string;              // ì„ íƒ ì—¬ë¶€
  PROD_CD: string;           // ìƒí’ˆì½”ë“œ
  SVC_CD: string;            // ì„œë¹„ìŠ¤ì½”ë“œ
  PROD_TYP: string;          // ìƒí’ˆíƒ€ì…
  PROD_GRP: string;          // ìƒí’ˆê·¸ë£¹
  EQT: string;               // ì¥ë¹„ì½”ë“œ (EQT_CD, ITEM_MID_CD)
  EQT_CD: string;            // ì¥ë¹„ì½”ë“œ (ë™ì¼)
  EQT_CL: string;            // ì¥ë¹„í´ë˜ìŠ¤ (ëª¨ë¸ì½”ë“œ)
  EQT_CL_NM: string;         // ì¥ë¹„í´ë˜ìŠ¤ëª… (ëª¨ë¸ëª…)
  ITM_MID_CD: string;        // ì•„ì´í…œì¤‘ë¶„ë¥˜ì½”ë“œ
  LENT: string;              // ì„ëŒ€êµ¬ë¶„ (10:êµ¬ë§¤, 30:ë Œíƒˆ, 31:í• ë¶€ ë“±)
  EQT_USE_STAT_CD: string;   // ì¥ë¹„ì‚¬ìš©ìƒíƒœ
  ITLLMT_PRD: string;        // í• ë¶€ê¸°ê°„
  LENT_YN: string;           // ì„ëŒ€ì—¬ë¶€
  EQT_SALE_AMT: number;      // íŒë§¤ê°€
  EQUIP_SEQ: string;         // ì¥ë¹„ìˆœë²ˆ
  EQT_BASIC_YN: string;      // ê¸°ë³¸ì¥ë¹„ì—¬ë¶€
  EQT_NM: string;            // ì¥ë¹„ëª…
  CMPS_QTY_FROM?: string;    // êµ¬ì„±ìˆ˜ëŸ‰
}

// ì„œë¹„ìŠ¤ êµ¬ì„± ì •ë³´ íƒ€ì…
export interface ServiceComposition {
  ITEM_MID_CDS: string;      // ì¥ë¹„ì½”ë“œ ëª©ë¡ (10ìë¦¬ì”© ì—°ê²°)
  EQT_CLS: string;           // ëª¨ë¸ì½”ë“œ ëª©ë¡ (10ìë¦¬ì”© ì—°ê²°)
  LENTS: string;             // ì„ëŒ€êµ¬ë¶„ ëª©ë¡ (2ìë¦¬ì”© ì—°ê²°)
  EQT_USE_STATS: string;     // ì‚¬ìš©ìƒíƒœ ëª©ë¡ (1ìë¦¬ì”© ì—°ê²°)
  ITLLMT_PRDS: string;       // í• ë¶€ê¸°ê°„ ëª©ë¡ (2ìë¦¬ì”© ì—°ê²°)
  EQT_SALE_AMTS: string;     // íŒë§¤ê°€ ëª©ë¡ (10ìë¦¬ì”© ì—°ê²°)
  PROD_CMPS_CLS?: string;    // ìƒí’ˆêµ¬ì„±ë¶„ë¥˜ (PROD_TYP + EQUIP_SEQ ì—°ê²°)
  PROD_GRPS?: string;        // ìƒí’ˆê·¸ë£¹ ëª©ë¡
  PROD_CDS?: string;         // ìƒí’ˆì½”ë“œ ëª©ë¡ (10ìë¦¬ì”© ì—°ê²°)
  SVC_CDS?: string;          // ì„œë¹„ìŠ¤ì½”ë“œ ëª©ë¡ (10ìë¦¬ì”© ì—°ê²°)
}

// ì¥ë¹„ íŒë§¤ ìƒí’ˆ íƒ€ì…
export interface EquipmentSaleProduct {
  PRED: string;              // ì„ í–‰ì—¬ë¶€
  EQT_USE_STAT_CD: string;   // ì¥ë¹„ì‚¬ìš©ìƒíƒœì½”ë“œ
  EQT_CL_CD: string;         // ì¥ë¹„í´ë˜ìŠ¤ì½”ë“œ
  INSTL_PERD: string;        // í• ë¶€ê¸°ê°„
}

// ê³µí†µì½”ë“œ íƒ€ì…
export interface CommonCode {
  COMMON_CD: string;         // ê³µí†µì½”ë“œ
  COMMON_CD_NM: string;      // ê³µí†µì½”ë“œëª…
  REF_CODE?: string;         // ì°¸ì¡°ì½”ë“œ
}

// ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‘ë‹µ
export interface ContractEquipmentListResponse {
  output1: ServiceComposition[];      // ì„œë¹„ìŠ¤ êµ¬ì„± ì •ë³´
  output2: ContractEquipment[];       // ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸
  output3: EquipmentSaleProduct[];    // ì¥ë¹„ íŒë§¤ ìƒí’ˆ ì •ë³´
}

/**
 * ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ì „ì²´ ì •ë³´ í¬í•¨)
 */
export const getContractEquipmentList = async (
  prodCd: string,
  ctrtId?: string
): Promise<ContractEquipmentListResponse> => {
  console.log('ğŸ” ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ API í˜¸ì¶œ:');
  console.log('  - PROD_CD:', prodCd);
  console.log('  - CTRT_ID:', ctrtId);

  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 500));
    return {
      output1: [{
        ITEM_MID_CDS: '05        10        ',
        EQT_CLS: 'STB001    MDM001    ',
        LENTS: '1030',
        EQT_USE_STATS: '11',
        ITLLMT_PRDS: '0000',
        EQT_SALE_AMTS: '0         0         '
      }],
      output2: [
        {
          SEL: '1',
          PROD_CD: prodCd,
          SVC_CD: 'SVC001',
          PROD_TYP: '01',
          PROD_GRP: 'V',
          EQT: '05',
          EQT_CD: '05',
          EQT_CL: 'STB001',
          EQT_CL_NM: 'STB-HD',
          ITM_MID_CD: '05',
          LENT: '10',
          EQT_USE_STAT_CD: '1',
          ITLLMT_PRD: '00',
          LENT_YN: 'Y',
          EQT_SALE_AMT: 0,
          EQUIP_SEQ: '1',
          EQT_BASIC_YN: 'Y',
          EQT_NM: 'ì…‹í†±ë°•ìŠ¤'
        },
        {
          SEL: '1',
          PROD_CD: prodCd,
          SVC_CD: 'SVC001',
          PROD_TYP: '01',
          PROD_GRP: 'V',
          EQT: '04',
          EQT_CD: '04',
          EQT_CL: 'MDM001',
          EQT_CL_NM: 'DOCSIS 3.0',
          ITM_MID_CD: '04',
          LENT: '30',
          EQT_USE_STAT_CD: '1',
          ITLLMT_PRD: '00',
          LENT_YN: 'Y',
          EQT_SALE_AMT: 0,
          EQUIP_SEQ: '2',
          EQT_BASIC_YN: 'Y',
          EQT_NM: 'ëª¨ë€'
        }
      ],
      output3: []
    };
  }

  try {
    const requestBody: any = {
      EQT_SEL: "0",
      PROD_CD: prodCd,
      BUGA_EQT_SEL: "Y",
    };

    if (ctrtId) {
      requestBody.CTRT_ID = ctrtId;
    }

    console.log('ğŸ“¤ ìš”ì²­ ë°ì´í„°:', requestBody);

    const response = await fetch(`${API_BASE}/customer/receipt/contract/getContractEqtList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    console.log('ğŸ“¥ getContractEqtList ì‘ë‹µ ë°ì´í„°:', data);

    return data;
  } catch (error) {
    console.error('âŒ ê³„ì•½ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ API ì—ëŸ¬:', error);
    throw error;
  }
};

/**
 * ê³µí†µì½”ë“œ ì¡°íšŒ
 */
export const getCommonCodeList = async (
  codeIds: string[]  // ['CMCU027', 'CMEP314', 'CMCU064']
): Promise<{ [key: string]: CommonCode[] }> => {
  console.log('ğŸ” ê³µí†µì½”ë“œ ì¡°íšŒ API í˜¸ì¶œ:', codeIds);

  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ê³µí†µì½”ë“œ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 300));

    const result: { [key: string]: CommonCode[] } = {};

    if (codeIds.includes('CMCU027')) {
      // ì„ëŒ€êµ¬ë¶„
      result['CMCU027'] = [
        { COMMON_CD: '10', COMMON_CD_NM: 'êµ¬ë§¤' },
        { COMMON_CD: '30', COMMON_CD_NM: 'ë Œíƒˆ' },
        { COMMON_CD: '31', COMMON_CD_NM: 'í• ë¶€' },
        { COMMON_CD: '60', COMMON_CD_NM: 'ë¬´ìƒ' },
      ];
    }

    if (codeIds.includes('CMEP314')) {
      // ì¥ë¹„ì‚¬ìš©ìƒíƒœ
      result['CMEP314'] = [
        { COMMON_CD: '1', COMMON_CD_NM: 'ì •ìƒ' },
        { COMMON_CD: '2', COMMON_CD_NM: 'ê³ ì¥' },
        { COMMON_CD: '3', COMMON_CD_NM: 'ë¶„ì‹¤' },
      ];
    }

    if (codeIds.includes('CMCU064')) {
      // í”„ë¡œëª¨ì…˜ê°œìˆ˜
      result['CMCU064'] = [
        { COMMON_CD: '0', COMMON_CD_NM: 'ì—†ìŒ' },
        { COMMON_CD: '1', COMMON_CD_NM: '1ê°œ' },
        { COMMON_CD: '2', COMMON_CD_NM: '2ê°œ' },
        { COMMON_CD: '3', COMMON_CD_NM: '3ê°œ' },
      ];
    }

    return result;
  }

  try {
    const requestBody = {
      CODE_IDS: codeIds.join(',')  // "CMCU027,CMEP314,CMCU064" (JSON body)
    };
    console.log('ğŸ“¤ ìš”ì²­ ë°ì´í„°:', requestBody);

    const response = await fetch(`${API_BASE}/common/getCommonCodeList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    console.log('ğŸ“¥ getCommonCodeList ì‘ë‹µ ë°ì´í„°:', data);

    return data;
  } catch (error) {
    console.error('âŒ ê³µí†µì½”ë“œ ì¡°íšŒ API ì—ëŸ¬:', error);
    throw error;
  }
};

// ê·¸ë£¹ëª… ê¸°ë°˜ ê³µí†µì½”ë“œ ì¡°íšŒ (ë ˆê±°ì‹œ í˜¸í™˜: ì„œë²„ì—ì„œ CODE_IDSë¡œ ë§¤í•‘)
export const getCommonCodeListByGroups = async (
  groupsCsv: string  // 'LENT,EQT_USE_STAT,ITLLMT_PRD'
): Promise<{ [key: string]: CommonCode[] }> => {
  try {
    const body = { P_COMM_GRP_CD: groupsCsv };
    const response = await fetch(`${API_BASE}/common/getCommonCodeList`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('âŒ ê·¸ë£¹ ê³µí†µì½”ë“œ ì¡°íšŒ API ì—ëŸ¬:', error);
    throw error;
  }
};

export const checkStbServerConnection = async (
  regUid: string,
  ctrtId: string,
  wrkId: string,
  msgId: string,
  stbEqtNo: string,
  modemEqtNo: string
): Promise<{
  MSGCODE: string;
  MESSAGE: string;
  O_IFSVC_RESULT?: string;
}> => {
  console.log('[STB API] ì„œë²„ ì—°ê²° ì²´í¬ API í˜¸ì¶œ');
  console.log('[STB API] ì…ë ¥ íŒŒë¼ë¯¸í„°:', { regUid, ctrtId, wrkId, msgId, stbEqtNo, modemEqtNo });

  const isDemoMode = checkDemoMode();
  console.log('[STB API] ë”ë¯¸ ëª¨ë“œ ì—¬ë¶€:', isDemoMode);

  if (isDemoMode) {
    console.log('[STB API] ë”ë¯¸ ëª¨ë“œ: STB ì—°ê²° ì²´í¬ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ API í˜¸ì¶œ ì•ˆí•¨)');
    await new Promise(resolve => setTimeout(resolve, 800));
    return {
      MSGCODE: 'SUCCESS',
      MESSAGE: 'STB server connection check completed',
      O_IFSVC_RESULT: 'TRUE0000000001SMR03000000'
    };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const url = `${origin}/api/customer/work/checkStbServerConnection`;

    const requestBody = {
      REG_UID: regUid,
      CTRT_ID: ctrtId,
      WRK_ID: wrkId,
      MSG_ID: msgId,
      STB_EQT_NO: stbEqtNo,
      MODEM_EQT_NO: modemEqtNo
    };

    console.log('[STB API] API URL:', url);
    console.log('[STB API] ìš”ì²­ ë°ì´í„°:', requestBody);
    console.log('[STB API] fetch í˜¸ì¶œ ì‹œì‘...');

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    console.log('[STB API] ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[STB API] HTTP ì—ëŸ¬ ì‘ë‹µ:', errorText);
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    console.log('[STB API] ì‘ë‹µ ë°ì´í„°:', data);

    return data;
  } catch (error) {
    console.error('[STB API] STB ì„œë²„ ì—°ê²° ì²´í¬ API ì—ëŸ¬:', error);
    throw error;
  }
};

/**
 * ì¥ë¹„ ëª¨ë¸ ì •ë³´ ë³€ê²½ (contract-item-model ë³€ê²½)
 * @param equipments - ì¥ë¹„ì •ë³´ë³€ê²½ ë°°ì—´ (ê° ì¥ë¹„ë§ˆë‹¤ ë³€ê²½í•  ITEM_MID_CD)
 * @param workId - ì‘ì—… ID
 * @param custId - ê³ ê° ID
 */
export const changeEquipmentModel = async (
  equipments: Array<{
    CTRT_ID: string;
    RCPT_ID?: string;
    CRR_ID?: string;
    WRKR_ID: string;
    REG_UID: string;
    ITEM_MID_CD: string;  // ì¥ë¹„ íƒ€ì… ì½”ë“œ (ìœ ì§€)
    EQT_CL: string;       // ë³€ê²½í•  ì¥ë¹„ ëª¨ë¸ ì½”ë“œ
    SVC_CMPS_ID?: string; // ì„œë¹„ìŠ¤ êµ¬ì„± ID
    PROD_CMPS_ID?: string; // ìƒí’ˆ êµ¬ì„± ID
  }>,
  workId: string,
  custId?: string
): Promise<{ MSGCODE: string; MESSAGE: string }> => {
  console.log('ğŸ”„ ì¥ë¹„ ëª¨ë¸ ì •ë³´ ë³€ê²½ API í˜¸ì¶œ:');
  console.log('  - ì¥ë¹„ ê°œìˆ˜:', equipments.length);
  console.log('  - WRK_ID:', workId);
  console.log('  - CUST_ID:', custId);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì¥ë¹„ ëª¨ë¸ ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { MSGCODE: 'SUCCESS', MESSAGE: 'ì¥ë¹„ ëª¨ë¸ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)' };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';

    const requestBody = {
      WRK_ID: workId,
      CUST_ID: custId || '',
      equipments: equipments
    };

    console.log('\nğŸš€ ==========================================');
    console.log('ğŸš€ ì¥ë¹„ ëª¨ë¸ ë³€ê²½ API í˜¸ì¶œ ì‹œì‘');
    console.log('ğŸš€ ==========================================');
    console.log('\nğŸ“¤ ì „ì†¡í•  ë°ì´í„°:');
    console.log(JSON.stringify(requestBody, null, 2));
    console.log('==========================================\n');

    const response = await fetchWithRetry(`${API_BASE}/customer/work/eqtCmpsInfoChg`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(requestBody),
    });

    const result = await response.json();

    console.log('\nğŸ“¥ ==========================================');
    console.log('ğŸ“¥ ì¥ë¹„ ëª¨ë¸ ë³€ê²½ API ì‘ë‹µ');
    console.log('ğŸ“¥ ==========================================');
    console.log('  â”œâ”€ MSGCODE:', result.MSGCODE);
    console.log('  â””â”€ MESSAGE:', result.MESSAGE);
    console.log('==========================================\n');

    if (result.MSGCODE !== 'SUCCESS' && result.MSGCODE !== '0') {
      throw new NetworkError(result.MESSAGE || 'ì¥ë¹„ ëª¨ë¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }

    return result;
  } catch (error) {
    console.error('âŒ ì¥ë¹„ ëª¨ë¸ ë³€ê²½ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì¥ë¹„ ëª¨ë¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * ì‹ í˜¸ ì ê²€ (ì§‘ì„  ì¡°íšŒ)
 */
export interface SignalCheckRequest {
  CUST_ID: string;          // ê³„ì•½ ID
  WRK_ID?: string;          // ì‘ì—… ID
  CHECK_TYPE: 'A' | 'B';    // A: ì¸í„°ë„·, B: TV/ë³µí•©
  PROD_CD?: string;         // ìƒí’ˆ ì½”ë“œ
}

export interface SignalCheckResult {
  checkType: 'A' | 'B';
  checkTime: string;
  status: 'success' | 'warning' | 'error';
  signalStrength?: number;
  speedTest?: {
    download: number;
    upload: number;
    ping: number;
  };
  deviceStatus?: {
    macAddress: string;
    connection: 'connected' | 'disconnected';
    ipAddress?: string;
  };
  tvSignal?: {
    channels: number;
    quality: number;
    errors: number;
  };
  issues?: string[];
}

/**
 * ì‹ í˜¸ ì ê²€ API (ì§‘ì„  ì¡°íšŒ)
 */
export const checkSignal = async (params: SignalCheckRequest): Promise<SignalCheckResult> => {
  console.log('ğŸ“¡ ì‹ í˜¸ ì ê²€ API í˜¸ì¶œ:', params);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì‹ í˜¸ ì ê²€ ë”ë¯¸ ë°ì´í„° ë°˜í™˜');
    await new Promise(resolve => setTimeout(resolve, 2000));

    const mockResult: SignalCheckResult = {
      checkType: params.CHECK_TYPE,
      checkTime: new Date().toLocaleString('ko-KR'),
      status: Math.random() > 0.2 ? 'success' : 'warning',
      signalStrength: Math.floor(Math.random() * 30) + 70,
    };

    if (params.CHECK_TYPE === 'A') {
      mockResult.speedTest = {
        download: Math.floor(Math.random() * 200) + 100,
        upload: Math.floor(Math.random() * 50) + 20,
        ping: Math.floor(Math.random() * 20) + 5,
      };
      mockResult.deviceStatus = {
        macAddress: 'AA:BB:CC:DD:EE:FF',
        connection: 'connected',
        ipAddress: `192.168.1.${Math.floor(Math.random() * 200) + 10}`,
      };
    } else {
      mockResult.tvSignal = {
        channels: Math.floor(Math.random() * 50) + 100,
        quality: Math.floor(Math.random() * 20) + 80,
        errors: Math.floor(Math.random() * 5),
      };
    }

    if (mockResult.status === 'warning') {
      mockResult.issues = [
        'ì‹ í˜¸ í’ˆì§ˆì´ ê¸°ì¤€ì¹˜ë³´ë‹¤ ì•½ê°„ ë‚®ìŠµë‹ˆë‹¤.',
        'ì¬ì ê²€ì„ ê¶Œì¥í•©ë‹ˆë‹¤.',
      ];
    }

    return mockResult;
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    const response = await fetchWithRetry(`${API_BASE}/customer/work/signalCheck`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(params),
    });

    const result = await response.json();
    console.log('âœ… ì‹ í˜¸ ì ê²€ ì„±ê³µ:', result);
    return result;
  } catch (error) {
    console.error('âŒ ì‹ í˜¸ ì ê²€ ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError('ì‹ í˜¸ ì ê²€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============ ì‘ì—… ì™„ë£Œ API ============

/**
 * ì‘ì—… ì™„ë£Œ ì²˜ë¦¬
 * 6ê°€ì§€ Datasetì„ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
export const completeWork = async (data: WorkCompleteData): Promise<{ code: string; message: string; data?: any }> => {
  console.log('ğŸš€ ì‘ì—… ì™„ë£Œ API í˜¸ì¶œ:', data);

  // ë”ë¯¸ ëª¨ë“œ ì²´í¬
  if (checkDemoMode()) {
    console.log('âš ï¸ ë”ë¯¸ ëª¨ë“œ: ì‘ì—… ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜');
    await new Promise(resolve => setTimeout(resolve, 1500));
    return {
      code: 'SUCCESS',
      message: 'ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (ë”ë¯¸)',
      data: {
        WRK_ID: data.workInfo.WRK_ID,
        WRK_STAT_CD: '4', // ì™„ë£Œ
        CMPL_DT: data.workInfo.WRKR_CMPL_DT
      }
    };
  }

  try {
    const origin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000';
    console.log('ğŸ“¡ ì‹¤ì œ ì‘ì—… ì™„ë£Œ API í˜¸ì¶œ:', `${API_BASE}/customer/work/workComplete`);

    const response = await fetchWithRetry(`${API_BASE}/customer/work/workComplete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': origin
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });

    console.log('ğŸ“¡ ì‘ì—… ì™„ë£Œ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

    const result = await response.json();
    console.log('âœ… ì‘ì—… ì™„ë£Œ API ì„±ê³µ:', result);

    return result;
  } catch (error: any) {
    console.error('âŒ ì‘ì—… ì™„ë£Œ API ì‹¤íŒ¨:', error);
    if (error instanceof NetworkError) {
      throw error;
    }
    throw new NetworkError(error.message || 'ì‘ì—… ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};